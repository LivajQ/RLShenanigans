package rlshenanigans.entity;

import io.netty.buffer.ByteBuf;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.init.MobEffects;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.potion.PotionEffect;
import net.minecraft.util.math.AxisAlignedBB;
import net.minecraft.world.World;
import net.minecraftforge.fml.relauncher.Side;
import net.minecraftforge.fml.relauncher.SideOnly;

import java.util.List;

public class EntitySpellInvulnerability extends EntitySpellBase {
    private int age = 0;
    private int maxGrowthAge;
    private int maxAge;
    
    public EntitySpellInvulnerability(World world) {
        this(world, 60, 600, 1.0F, 1.0F, 1.0F, 1.0F);
    }
    
    public EntitySpellInvulnerability(World world, int maxGrowthAge, int maxAge, float red, float green, float blue, float alpha) {
        super(world, red, green, blue, alpha);
        
        this.setSize(0.0F, 0.0F);
        this.noClip = true;
        this.maxGrowthAge = maxGrowthAge;
        this.maxAge = maxAge;
    }
    
    @Override
    public void onUpdate() {
        super.onUpdate();
        
        if(maxAge == 0) return;
        age++;
        
        float size = Math.min(1.0F, (float) age / (float) maxGrowthAge) * 15;
        this.setSize(size, size);
        
        AxisAlignedBB box = this.getEntityBoundingBox();
        List<EntityLivingBase> targets = world.getEntitiesWithinAABB(EntityLivingBase.class, box);
        for (EntityLivingBase target : targets) {
            if (!target.isPotionActive(MobEffects.RESISTANCE)) {
                target.addPotionEffect(new PotionEffect(MobEffects.RESISTANCE, 20, 4));
            }
        }
        
        if (age >= maxAge) this.setDead();
    }
    
    @Override
    public void setSize(float width, float height) {
        AxisAlignedBB box = this.getEntityBoundingBox();
        double centerX = (box.minX + box.maxX) / 2.0;
        double centerY = (box.minY + box.maxY) / 2.0;
        double centerZ = (box.minZ + box.maxZ) / 2.0;
        
        this.width = width;
        this.height = height;
        
        double w = width / 2.0;
        double h = height / 2.0;
        
        // Expand evenly in all directions
        this.setEntityBoundingBox(new AxisAlignedBB(
                centerX - w,
                centerY - h,
                centerZ - w,
                centerX + w,
                centerY + h,
                centerZ + w
        ));
    }
    
    @Override
    @SideOnly(Side.CLIENT)
    public boolean isInRangeToRender3d(double x, double y, double z) {
        return true;
    }
    
    @Override
    @SideOnly(Side.CLIENT)
    public boolean isInRangeToRenderDist(double distance) {
        return true;
    }
    
    @Override
    @SideOnly(Side.CLIENT)
    public AxisAlignedBB getRenderBoundingBox() {
        double r = Math.max(width, height) * 2.0;
        return new AxisAlignedBB(
                posX - r,
                posY - r,
                posZ - r,
                posX + r,
                posY + r,
                posZ + r
        );
    }
    
    @Override
    public void writeEntityToNBT(NBTTagCompound compound) {
        super.writeEntityToNBT(compound);
        compound.setInteger("Age", age);
        compound.setInteger("MaxGrowthAge", maxGrowthAge);
        compound.setInteger("MaxAge", maxAge);
    }
    
    @Override
    public void readEntityFromNBT(NBTTagCompound compound) {
        super.readEntityFromNBT(compound);
        age = compound.getInteger("Age");
        maxGrowthAge = compound.getInteger("MaxGrowthAge");
        maxAge = compound.getInteger("MaxAge");
    }
    
    @Override
    public void writeSpawnData(ByteBuf buffer) {
        super.writeSpawnData(buffer);
        buffer.writeInt(this.age);
        buffer.writeInt(this.maxGrowthAge);
        buffer.writeInt(this.maxAge);
    }
    
    @Override
    public void readSpawnData(ByteBuf buffer) {
        super.readSpawnData(buffer);
        this.age = buffer.readInt();
        this.maxGrowthAge = buffer.readInt();
        this.maxAge = buffer.readInt();
    }
}