package rlshenanigans.entity;

import net.minecraft.entity.Entity;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.entity.IProjectile;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.util.EnumParticleTypes;
import net.minecraft.util.math.AxisAlignedBB;
import net.minecraft.world.World;
import net.minecraftforge.event.entity.living.LivingAttackEvent;
import net.minecraftforge.fml.common.Mod;
import net.minecraftforge.fml.common.eventhandler.EventPriority;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;
import rlshenanigans.RLShenanigans;
import rlshenanigans.client.particle.ParticleSpell;
import rlshenanigans.handlers.RLSPacketHandler;
import rlshenanigans.item.ItemSpellList;
import rlshenanigans.packet.SpellParticlePacket;

import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.UUID;

@Mod.EventBusSubscriber(modid = RLShenanigans.MODID)
public class EntitySpellInvulnerability extends EntitySpellBase {
    private int age = 0;
    private int maxGrowthAge;
    private int maxAge;
    private final EntityLivingBase caster;
    
    public static final Set<UUID> protectedEntities = new HashSet<>();
    
    public EntitySpellInvulnerability(World world)
    {
        this(null, world, 60, 600, 1.0F, 1.0F, 1.0F, 1.0F);
    }
    
    public EntitySpellInvulnerability(EntityLivingBase caster, World world, int maxGrowthAge, int maxAge, float red, float green, float blue, float alpha) {
        super(world, red, green, blue, alpha);
        
        this.setSize(0.0F, 0.0F);
        this.noClip = true;
        this.maxGrowthAge = maxGrowthAge;
        this.maxAge = maxAge;
        this.caster = caster;
        this.ignoreFrustumCheck = true;
    }
    
    @Override
    public void onUpdate() {
        super.onUpdate();
        
        if (maxAge == 0) return;
        age++;
        
        if (caster != null) this.setPosition(caster.posX, caster.posY, caster.posZ);
        
        float size = Math.min(1.0F, (float) age / (float) maxGrowthAge) * 24;
        this.width = size;
        this.height = size;
        
        if (!world.isRemote) {
            AxisAlignedBB box = this.getEntityBoundingBox();
            List<Entity> entities = world.getEntitiesWithinAABB(Entity.class, box);
            
            for (Entity entity : entities) {
                if (entity instanceof EntityLivingBase) protectedEntities.add(entity.getUniqueID());
                else if (entity instanceof IProjectile) entity.setDead();
            }
            
            this.spawnParticle(15);
            
            if (age >= maxAge) {
                protectedEntities.clear();
                this.setDead();
            }
        }
    }
    
    @Override
    public void setPositionAndRotation(double x, double y, double z, float yaw, float pitch) {
        super.setPosition(x, y, z);
        this.rotationYaw = 0.0F;
        this.rotationPitch = 0.0F;
    }
    
    @Override
    public AxisAlignedBB getEntityBoundingBox() {
        float halfHeight = this.height / 2.0F;
        return new AxisAlignedBB(
                this.posX - this.width / 2.0F,
                this.posY - halfHeight,
                this.posZ - this.width / 2.0F,
                this.posX + this.width / 2.0F,
                this.posY + halfHeight,
                this.posZ + this.width / 2.0F
        );
    }
    
    @Override
    public void readEntityFromNBT(NBTTagCompound compound) {
        protectedEntities.clear();
        this.setDead();
    }
    
    @Override
    public boolean movingTexture() {
        return true;
    }
    
    @Override
    public float textureScale() {
        return 12.0F;
    }
    
    public void spawnParticle(int amount) {
        for (int i = 0; i < amount; i++) {
            double minX = this.getEntityBoundingBox().minX;
            double minY = this.getEntityBoundingBox().minY;
            double minZ = this.getEntityBoundingBox().minZ;
            double maxX = this.getEntityBoundingBox().maxX;
            double maxY = this.getEntityBoundingBox().maxY;
            double maxZ = this.getEntityBoundingBox().maxZ;
            
            double x = minX + (maxX - minX) * world.rand.nextDouble();
            double y = minY + (maxY - minY) * world.rand.nextDouble();
            double z = minZ + (maxZ - minZ) * world.rand.nextDouble();
            
            double motionX = (world.rand.nextDouble() - 0.5D) * 0.1D;
            double motionY = (world.rand.nextDouble() - 0.5D) * 0.1D;
            double motionZ = (world.rand.nextDouble() - 0.5D) * 0.1D;
            
            RLSPacketHandler.INSTANCE.sendToAllTracking(
                    new SpellParticlePacket(
                            ItemSpellList.SPELL_INVULNERABILITY,
                            ParticleSpell.getTextureIndexFromEnum(EnumParticleTypes.REDSTONE),
                            x, y, z,
                            motionX, motionY, motionZ,
                            1, 40
                    ), this
            );
        }
    }
    
    @SubscribeEvent(priority = EventPriority.HIGHEST)
    public static void onLivingAttack(LivingAttackEvent event) {
        EntityLivingBase target = event.getEntityLiving();
        if (protectedEntities.contains(target.getUniqueID())) event.setCanceled(true);
    }
}